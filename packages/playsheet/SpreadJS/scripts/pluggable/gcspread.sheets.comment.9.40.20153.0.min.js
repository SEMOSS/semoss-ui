/*
 *
 * SpreadJS Library 9.40.20153.0
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 *
 * Licensed under the SpreadJS Commercial License. 
 * spread.sales@grapecity.com
 * http://spread.grapecity.com/Pages/Spread-JS-License/
 *
 *
 **/
var GcSpread;(function(n){(function(n){var a,o,w,c,l,v,y;n.feature("comment",["core.common","core.sheet_action"]);var t=null,i=undefined,f="mousewheel",e="DOMMouseScroll",r=Math.max,u=Math.min,s=Math.floor,p=Math.atan2,h=Math.abs;(function(n){n[n.AlwaysShown=1]="AlwaysShown";n[n.HoverShown=2]="HoverShown"})(n.DisplayMode||(n.DisplayMode={}));a=n.DisplayMode;o=function(){function n(n,t,i,r){this.left=0;this.top=0;this.right=0;this.bottom=0;var u=this;arguments.length===1?u.top=u.right=u.bottom=u.left=n:arguments.length===4&&(u.top=n,u.right=t,u.bottom=i,u.left=r)}return n.prototype.toString=function(){var n=this;return n.top+"px "+n.right+"px "+n.bottom+"px "+n.left+"px"},n}();n.Padding=o,function(n){n[n.TopLeft=0]="TopLeft";n[n.TopRight=1]="TopRight";n[n.BottomLeft=2]="BottomLeft";n[n.BottomRight=3]="BottomRight";n[n.MiddleLeft=4]="MiddleLeft";n[n.MiddleRight=5]="MiddleRight";n[n.TopCenter=6]="TopCenter";n[n.BottomCenter=7]="BottomCenter"}(n.ResizeDirection||(n.ResizeDirection={}));w=n.ResizeDirection;c=function(){function r(){var i=this;i._defaultLocation=new n.Point(9,-18);i._text="";i._location=i._defaultLocation;i._displayMode=2;i._commentState=3;i._width=160;i._height=100;i._fontFamily="Arial";i._fontStyle="normal";i._fontSize="9pt";i._fontWeight="normal";i._textDecoration=0;i._foreColor="black";i._backColor="#FFFFE1";i._opacity=1;i._locked=!0;i._lockText=!0;i._dynamicMove=!0;i._dynamicSize=!0;i._horizontalAlign=0;i._autoSize=!1;i._borderWidth=1;i._borderStyle="solid";i._borderColor="black";i._padding=t;i._zIndex=-1;i._showShadow=!1;i._timeout=t;i._rowIndex=-1;i._colIndex=-1;i._sheet=t}return r.prototype.text=function(n){var t=this;return arguments.length===0?t._text:(typeof n=="string"&&t._text!==n&&t._changeProperty("text",n),t)},r.prototype.location=function(t){var i=this;return arguments.length===0?i._location:(t instanceof n.Point&&i._location!==t&&i._changeProperty("location",t),i)},r.prototype.width=function(n){var t=this;return arguments.length===0?t._width:(typeof n=="number"&&n>0&&t._width!==n&&(t._autoSize=!1,t._changeProperty("width",n)),t)},r.prototype.height=function(n){var t=this;return arguments.length===0?t._height:(typeof n=="number"&&n>0&&t._height!==n&&(t._autoSize=!1,t._changeProperty("height",n)),t)},r.prototype.fontFamily=function(n){var t=this;return arguments.length===0?t._fontFamily:(typeof n=="string"&&t._fontFamily!==n&&t._changeProperty("fontFamily",n),t)},r.prototype.fontStyle=function(n){var t=this;return arguments.length===0?t._fontStyle:(typeof n=="string"&&t._fontStyle!==n&&t._changeProperty("fontStyle",n),t)},r.prototype.fontSize=function(n){var t=this;return arguments.length===0?t._fontSize:(typeof n=="string"&&t._fontSize!==n&&t._changeProperty("fontSize",n),t)},r.prototype.fontWeight=function(n){var t=this;return arguments.length===0?t._fontWeight:(typeof n=="string"&&t._fontWeight!==n&&t._changeProperty("fontWeight",n),t)},r.prototype.textDecoration=function(n){var t=this;return arguments.length===0?t._textDecoration:(t._textDecoration!==n&&t._changeProperty("textDecoration",n),t)},r.prototype.foreColor=function(n){var t=this;return arguments.length===0?t._foreColor:(typeof n=="string"&&t._foreColor!==n&&t._changeProperty("foreColor",n),t)},r.prototype.locked=function(n){var t=this;return arguments.length===0?t._locked:(typeof n=="boolean"&&t._locked!==n&&t._changeProperty("locked",n),t)},r.prototype.lockText=function(n){var t=this;return arguments.length===0?t._lockText:(typeof n=="boolean"&&t._lockText!==n&&t._changeProperty("lockText",n),t)},r.prototype.horizontalAlign=function(t){var r=this;return arguments.length===0?r._horizontalAlign:(n.HorizontalAlign[t]!==i&&r._horizontalAlign!==t&&r._changeProperty("horizontalAlign",t),r)},r.prototype.autoSize=function(n){var t=this;return arguments.length===0?t._autoSize:(typeof n=="boolean"&&t._autoSize!==n&&t._changeProperty("autoSize",n),t)},r.prototype.dynamicSize=function(n){var t=this;if(arguments.length===0)return t._dynamicSize;else{if(typeof n=="boolean"&&t._dynamicSize!==n){if(n===!0&&t._dynamicMove===!1)return t;t._changeProperty("dynamicSize",n)}return t}},r.prototype.dynamicMove=function(n){var t=this;return arguments.length===0?t._dynamicMove:(typeof n=="boolean"&&t._dynamicMove!==n&&(n===!1&&t._dynamicSize===!0&&(t._dynamicSize=!1),t._changeProperty("dynamicMove",n)),t)},r.prototype.backColor=function(n){var t=this;return arguments.length===0?t._backColor:(typeof n=="string"&&t._backColor!==n&&t._changeProperty("backColor",n),t)},r.prototype.opacity=function(n){var t=this;return arguments.length===0?t._opacity:(typeof n=="number"&&n>=0&&n<=1&&t._opacity!==n&&t._changeProperty("opacity",n),t)},r.prototype.borderWidth=function(n){var t=this;return arguments.length===0?t._borderWidth:(typeof n=="number"&&n>0&&t._borderWidth!==n&&t._changeProperty("borderWidth",n),t)},r.prototype.borderStyle=function(n){var t=this;return arguments.length===0?t._borderStyle:(typeof n=="string"&&t._borderStyle!==n&&t._changeProperty("borderStyle",n),t)},r.prototype.borderColor=function(n){var t=this;return arguments.length===0?t._borderColor:(typeof n=="string"&&t._borderColor!==n&&t._changeProperty("borderColor",n),t)},r.prototype.padding=function(n){var i=this;return arguments.length===0?i._padding:((n===t||n instanceof o)&&i._padding!==n&&i._changeProperty("padding",n),i)},r.prototype.showShadow=function(n){var t=this;return arguments.length===0?t._showShadow:(typeof n=="boolean"&&t._showShadow!==n&&t._changeProperty("showShadow",n),t)},r.prototype.displayMode=function(n){var t=this;return arguments.length===0?t._displayMode:(a[n]!==i&&t._displayMode!==n&&t._changeProperty("displayMode",n),t)},r.prototype.commentState=function(t){var r=this;return arguments.length===0?r._commentState:(n.CommentState[t]!==i&&r._commentState!==t&&r._changeProperty("commentState",t),r)},r.prototype.zIndex=function(n){var t=this;return arguments.length===0?t._zIndex:(typeof n=="number"&&t._zIndex!==n&&t._changeProperty("zIndex",n),t)},r.prototype._changeProperty=function(n,t){var i=this,r=i._sheet,u="_"+n;r?r._bindToAutoRefresh(function(n){i.hasOwnProperty(u)&&(i[u]=n)})(t):i.hasOwnProperty(u)&&(i[u]=t);this._sheet&&this._sheet.triggerCommentChanged({sheet:r,sheetName:r?r._name:"",comment:i,propertyName:n})},r.prototype.clone=function(){var t=this,i=new r;return i._text=t._text,i._location=new n.Point(t._location.x,t._location.y),t._defaultLocation&&(i._defaultLocation=new n.Point(t._defaultLocation.x,t._defaultLocation.y)),i._width=t._width,i._height=t._height,i._fontFamily=t._fontFamily,i._fontStyle=t._fontStyle,i._fontSize=t._fontSize,i._fontWeight=t._fontWeight,i._textDecoration=t._textDecoration,i._foreColor=t._foreColor,i._locked=t._locked,i._lockText=t._lockText,i._horizontalAlign=t._horizontalAlign,i._autoSize=t._autoSize,i._dynamicMove=t._dynamicMove,i._dynamicSize=t._dynamicSize,i._backColor=t._backColor,i._opacity=t._opacity,i._borderWidth=t._borderWidth,i._borderStyle=t._borderStyle,i._borderColor=t._borderColor,t._padding&&(i._padding=new o(t._padding.top,t._padding.right,t._padding.bottom,t._padding.left)),i._showShadow=t._showShadow,i._displayMode=t._displayMode,i._commentState=t._commentState,i._sheet=t._sheet,i._rowIndex=t._rowIndex,i._colIndex=t._colIndex,i._zIndex=t._zIndex,i},r.prototype.toJSON=function(){var n=this,r={text:n._text,location:n._location,displayMode:n._displayMode,commentState:n._commentState,width:n._width,height:n._height,fontFamily:n._fontFamily,fontStyle:n._fontStyle,fontSize:n._fontSize,fontWeight:n._fontWeight,textDecoration:n._textDecoration,foreColor:n._foreColor,backColor:n._backColor,opacity:n._opacity,locked:n._locked,lockText:n._lockText,dynamicMove:n._dynamicMove,dynamicSize:n._dynamicSize,horizontalAlign:n._horizontalAlign,autoSize:n._autoSize,borderWidth:n._borderWidth,borderStyle:n._borderStyle,borderColor:n._borderColor,padding:n._padding,zIndex:n._zIndex,showShadow:n._showShadow,rowIndex:n._rowIndex,colIndex:n._colIndex},u={},t,i;for(t in r)i=r[t],n._isDefaultValue(t,i)||(u[t]=i);return u},r.prototype._isDefaultValue=function(n,t){switch(n){case"text":return t==="";case"location":return t.x===9&&t.y===-18;case"displayMode":return t===2;case"commentState":return t===3;case"width":return t===160;case"height":return t===100;case"fontFamily":return t==="Arial";case"fontStyle":return t==="normal";case"fontSize":return t==="9pt";case"fontWeight":return t==="normal";case"textDecoration":return t===0;case"foreColor":return t==="black";case"backColor":return t==="#FFFFE1";case"opacity":return t===1;case"locked":return t===!0;case"lockText":return t===!0;case"dynamicMove":return t===!0;case"dynamicSize":return t===!0;case"horizontalAlign":return t===0;case"autoSize":return t===!1;case"borderWidth":return t===1;case"borderStyle":return t==="solid";case"borderColor":return t==="black";case"padding":return t===null;case"zIndex":return t===-1;case"showShadow":return t===!1;case"rowIndex":return t===-1;case"colIndex":return t===-1;default:return!1}},r.prototype.fromJSON=function(t,r){var u,e,f;t&&(u=this,t.text!==i&&(u._text=t.text),e=t.location,e!==i&&(u._location=new n.Point(e.x,e.y)),t.displayMode!==i&&(u._displayMode=t.displayMode),t.commentState!==i&&(u._commentState=t.commentState),t.width!==i&&(u._width=t.width),t.height!==i&&(u._height=t.height),t.fontFamily!==i&&(u._fontFamily=t.fontFamily),t.fontStyle!==i&&(u._fontStyle=t.fontStyle),t.fontSize!==i&&(u._fontSize=t.fontSize),t.fontWeight!==i&&(u._fontWeight=t.fontWeight),t.textDecoration!==i&&(u._textDecoration=t.textDecoration),t.foreColor!==i&&(u._foreColor=t.foreColor),t.backColor!==i&&(u._backColor=t.backColor),t.opacity!==i&&(u._opacity=t.opacity),t.locked!==i&&(u._locked=t.locked),t.lockText!==i&&(u._lockText=t.lockText),t.dynamicMove!==i&&(u._dynamicMove=t.dynamicMove),t.dynamicSize!==i&&(u._dynamicSize=t.dynamicSize),t.horizontalAlign!==i&&(u._horizontalAlign=t.horizontalAlign),t.autoSize!==i&&(u._autoSize=t.autoSize),t.borderWidth!==i&&(u._borderWidth=t.borderWidth),t.borderStyle!==i&&(u._borderStyle=t.borderStyle),t.borderColor!==i&&(u._borderColor=t.borderColor),f=t.padding,f!==i&&(u._padding=new o(f.top,f.right,f.bottom,f.left)),t.zIndex!==i&&(u._zIndex=t.zIndex),t.showShadow!==i&&(u._showShadow=t.showShadow),t.rowIndex!==i&&(u._rowIndex=t.rowIndex),t.colIndex!==i&&(u._colIndex=t.colIndex))},r}();n.Comment=c;l=function(){function o(t,i){var r,f,u;this._rowViewportIndex=1;this._columnViewportIndex=1;r=this;f=t&&t._sheet;r._comment=t;r._updateCommentViewportIndex();r._zoomFactor=f._zoomFactor;r._commentManager=i;r._editor=i._editorDom;r._init();u=r._getAdjustedCommentRect(r._getAbsLocation(),t.width(),t.height());r._absLocation=new n.Point(u.x,u.y);r._updateStartCoordinate();r._updateEndCoordinate()}return o.prototype._init=function(){var i=this,r;i._commentLayoutPanel=t;i._floatBlockCanvasContainer=t;i._floatBlockCanvas=t;i._hostContainer=t;i._host=t;i._lineCanvasContainer=t;i._lineCanvas=t;i._floatBlockCanvasContainerClassName="gc-spread-floatBlockCanvas-container";i._floatBlockCanvasClassName="gc-spread-floatBlockCanvas";i._hostContainerClassName="gc-spread-host-container";i._hostClassName="gc-spread-host";i._lineCanvasContainerClassName="gc-spread-lineCanvas-container";i._lineCanvasClassName="gc-spread-lineCanvas";i._floatBlockCanvasContainer=document.createElement("div");n.GC$(i._floatBlockCanvasContainer).addClass(i._floatBlockCanvasContainerClassName).css("position","absolute").css("overflow","hidden").css("box-sizing","content-box");i._floatBlockCanvas=document.createElement("canvas");n.DPIHelper.adjustDevicePixel(i._floatBlockCanvas,null,i._commentManager._sheet);n.GC$(i._floatBlockCanvas).addClass(i._floatBlockCanvasClassName).css("left",0).css("top",0).css("position","absolute");i._hostContainer=document.createElement("div");n.GC$(i._hostContainer).addClass(i._hostContainerClassName).css("position","absolute").css("box-sizing","content-box");i._host=document.createElement("div");n.GC$(i._host).addClass(i._hostClassName+" no-user-select").css("left",0).css("top",0).css("width","100%").css("height","100%").css("position","absolute").css("word-wrap","break-word").css("word-break","normal").css("white-space","pre-wrap").css("overflow","hidden").css("box-sizing","content-box").attr("unselectable","on");n.GC$(i._hostContainer).append(i._host);n.GC$(i._floatBlockCanvasContainer).append(i._floatBlockCanvas).append(i._hostContainer);i._lineCanvasContainer=document.createElement("div");n.GC$(i._lineCanvasContainer).addClass(i._lineCanvasContainerClassName).css("position","absolute").css("overflow","hidden");i._lineCanvas=document.createElement("canvas");n.DPIHelper.adjustDevicePixel(i._lineCanvas,null,i._commentManager._sheet);n.GC$(i._lineCanvas).addClass(i._lineCanvasClassName).css("left",0).css("right",0).css("position","absolute");n.GC$(i._lineCanvasContainer).append(i._lineCanvas);i._adornerDrawState=t;i._resizeHitRects=[];i._hostMargin=7;i._isMoving=!1;i._isResizing=!1;r=i._comment._sheet;n.features.touch&&(i._touchManager=new n.CommentTouchManager(i._floatBlockCanvas,i,r.parent._touchEventProvider),i._touchManager.attach(),i._touchContentManager=new n.CommentContentTouchManager(i._host,i,r.parent._touchEventProvider),i._touchContentManager.attach())},o.prototype.open=function(){var n=this,t=n._comment._sheet;(n._commentLayoutPanel||(t&&(n._commentLayoutPanel=t._commentRender._commentLayoutPanel),n._commentLayoutPanel))&&(n._commentLayoutPanel.appendChild(n._lineCanvasContainer),n._attachLineCanvasEventHandler(),n._commentLayoutPanel.appendChild(n._floatBlockCanvasContainer),n._attachFloatBlockCanvasEventHandler(),n._attachHostContainerEventHandler(),n.isEditing()?n._attachEditorEventHandler():n._attachHostEventHandler(),n._absLocation=n._getAbsLocation(),n.updateLayout())},o.prototype.close=function(){var t=this;t._floatBlockCanvasContainer&&t._lineCanvasContainer&&t._commentLayoutPanel&&(t._detachFloatBlockCanvasEventHandler(),t._detachHostContainerEventHandler(),t._detachHostEventHandler(),t._detachLineCanvasEventHandler(),t._detachEditorEventHandler(),n.GC$(t._floatBlockCanvasContainer).remove(),n.GC$(t._lineCanvasContainer).remove())},o.prototype.getComment=function(){return this._comment},o.prototype._getActualWidth=function(){return this._comment.width()*this._zoomFactor},o.prototype._getActualHeight=function(){return this._comment.height()*this._zoomFactor},o.prototype._getAbsLocation=function(){var n=this,t=n._comment;return t===n._commentManager.getHoverShownComment()&&t.commentState()===3?n._convertRelLocationToAbsLocation(t._defaultLocation):n._convertRelLocationToAbsLocation(t.location())},o.prototype._convertRelLocationToAbsLocation=function(t){var r=this,u=r._comment,f=u&&u._sheet,s=r._zoomFactor,e=new n.Point(0,0),i,o;return f&&(i=r._getCellRect(f,u._rowIndex,u._colIndex,r._rowViewportIndex,r._columnViewportIndex),i.x!==null&&i.x!==undefined&&i.y!==null&&i.y!==undefined&&i.width&&i.height&&(o=f._getSheetLayout(),e.x=i.x+i.width+t.x*s-o.rowHeaderWidth,e.y=i.y+t.y*s-o.colHeaderHeight)),e},o.prototype._getCellRect=function(f,e,o,s,h){for(var p,a,g=this,c=new n.Rect(0,0,0,0),l=f._getSheetLayout(),w=f.getViewportTopRow(s),b=f.getViewportLeftColumn(h),nt=u(w,e),tt=r(w,e),it=u(b,o),rt=r(b,o),k=0,d=0,y=g._zoomFactor,v=nt;v<tt;v++)d+=f.getRowHeight(v,3)*y;for(a=it;a<rt;a++)k+=f.getColumnWidth(a,3)*y;if(c.y=e>=w?d:-d,c.x=o>=b?k:-k,p=f.getSpan(e,o),p!=i&&p!=t){for(v=0;v<p.rowCount;v++)c.height+=f.getRowHeight(e+v)*y;for(a=0;a<p.colCount;a++)c.width+=f.getColumnWidth(o+a)*y}else c.height=f.getRowHeight(e)*y,c.width=f.getColumnWidth(o)*y;return c.x+=l.rowHeaderWidth,c.y+=l.colHeaderHeight,s===1?c.y+=l.frozenHeight:s===2&&(c.y+=l.frozenHeight+l.viewportHeight),h===1?c.x+=l.frozenWidth:h===2&&(c.x+=l.frozenWidth+l.viewportWidth),c},o.prototype._convertAbsLocationToRelLocation=function(t){var r=this,u=r._comment,f=u&&u._sheet,s=r._zoomFactor,e=new n.Point(0,0),i,o;return f&&(i=r._getCellRect(f,u._rowIndex,u._colIndex,r._rowViewportIndex,r._columnViewportIndex),i.x!==null&&i.x!==undefined&&i.y!==null&&i.y!==undefined&&i.width&&i.height&&(o=f._getSheetLayout(),e.x=(t.x-(i.x+i.width-o.rowHeaderWidth))/s,e.y=(t.y-(i.y-o.colHeaderHeight))/s)),e},o.prototype.updateLayoutWhenLocationChanged=function(){var n=this;n._absLocation=n._getAbsLocation();n._updateStartCoordinate();n._updateEndCoordinate();n.updateLayout()},o.prototype.updateLayoutWhenWidthHeightChanged=function(){var n=this;n._absLocation=n._getAbsLocation();n._updateEndCoordinate()},o.prototype.updateLayoutWhenRowColumnChanged=function(){var n=this,t=n._comment,i;t.dynamicMove()?t.dynamicSize()?(n._updateSizeByCoordinate(),n._updateLocationByCoordinate()):(n._updateLocationByCoordinate(),n._updateEndCoordinate()):(n._updateStartCoordinate(),n._updateEndCoordinate(),i=n._convertAbsLocationToRelLocation(n._absLocation),t.location(i))},o.prototype.updateLayoutWhenCellSpanChanged=function(){var n=this;n._absLocation=n._getAbsLocation();n.updateLayout()},o.prototype.updateLayoutWhenSheetScroll=function(){var n=this;n._absLocation=n._getAbsLocation();n.updateLayout()},o.prototype._updateLocationByCoordinate=function(){var n=this,t=n._comment,r=t&&t._sheet,i=n._getLocationByCoordinate();n._absLocation=i;t._location=n._convertAbsLocationToRelLocation(i);n.updateLayout()},o.prototype._getLocationByCoordinate=function(){var t=this,a=t._comment,i=a&&a._sheet,o=t._zoomFactor,s=i.getViewportLeftColumn(t._columnViewportIndex),h=i.getViewportTopRow(t._rowViewportIndex),v=t._getViewportRect(t._rowViewportIndex,t._columnViewportIndex),r,u,c,f,e,l;if(t._columnViewportIndex===0?r=0:t._columnViewportIndex===1?r=i.getViewportWidth(0):t._columnViewportIndex===2&&(r=i.getViewportWidth(0)+i.getViewportWidth(1)),s<t._startColumn)for(u=s;u<t._startColumn;u++)r+=i.getColumnWidth(u,3)*o;else for(u=t._startColumn;u<s;u++)r-=i.getColumnWidth(u,3)*o;if(c=i.getColumnWidth(t._startColumn,3),c<t._startColumnOffset&&(t._startColumnOffset=c),r=r+t._startColumnOffset*o,t._rowViewportIndex===0?f=0:t._rowViewportIndex===1?f=i.getViewportHeight(0):t._rowViewportIndex===2&&(f=i.getViewportHeight(0)+i.getViewportHeight(1)),h<t._startRow)for(e=h;e<t._startRow;e++)f+=i.getRowHeight(e,3)*o;else for(e=t._startRow;e<h;e++)f-=i.getRowHeight(e,3)*o;return l=i.getRowHeight(t._startRow,3),l<t._startRowOffset&&(t._startRowOffset=l),f=f+t._startRowOffset*o,new n.Point(r,f)},o.prototype._updateSizeByCoordinate=function(){for(var o,s,i,f,h,c,n=this,r=n._comment,t=r&&r._sheet,l=n._zoomFactor,u=0,e=n._startColumn;e<n._endColumn;e++)u+=t.getColumnWidth(e,3);for(o=t.getColumnWidth(n._startColumn,3),o<n._startColumnOffset&&(n._startColumnOffset=o),s=t.getColumnWidth(n._endColumn,3),s<n._endColumnOffset&&(n._endColumnOffset=s),u=u-n._startColumnOffset+n._endColumnOffset,i=0,f=n._startRow;f<n._endRow;f++)i+=t.getRowHeight(f,3);h=t.getRowHeight(n._startRow,3);h<n._startRowOffset&&(n._startRowOffset=h);c=t.getRowHeight(n._endRow,3);c<n._endRowOffset&&(n._endRowOffset=c);i=i-n._startRowOffset+n._endRowOffset;r.width(u);r.height(i)},o.prototype._updateStartCoordinate=function(){var t=this,v=t._comment,i=v&&v._sheet,f=t._zoomFactor,o,r,l,u,a;if(t._absLocation){var w=t._getViewportRect(t._rowViewportIndex,t._columnViewportIndex),y=i.getViewportLeftColumn(t._columnViewportIndex),p=i.getViewportTopRow(t._rowViewportIndex),e;t._columnViewportIndex===0?e=t._absLocation.x:t._columnViewportIndex===1?e=t._absLocation.x-i.getViewportWidth(0):t._columnViewportIndex===2&&(e=t._absLocation.x-(i.getViewportWidth(0)+i.getViewportWidth(1)));t._rowViewportIndex===0?o=t._absLocation.y:t._rowViewportIndex===1?o=t._absLocation.y-i.getViewportHeight(0):t._rowViewportIndex===2&&(o=t._absLocation.y-(i.getViewportHeight(0)+i.getViewportHeight(1)));var s=new n.Point(e,o),h=0,c=0;for(r=y;r<i.getColumnCount();r++)if(l=i.getColumnWidth(r,3)*f,h+l<s.x)h+=l;else{t._startColumn=r;t._startColumnOffset=(s.x-h)/f;break}for(u=p;u<i.getRowCount();u++)if(a=i.getRowHeight(u,3)*f,c+a<s.y)c+=a;else{t._startRow=u;t._startRowOffset=(s.y-c)/f;break}}},o.prototype._updateEndCoordinate=function(){var t=this,v=t._comment,i=v&&v._sheet,f=t._zoomFactor,o,r,l,u,a;if(t._absLocation){var w=t._getViewportRect(t._rowViewportIndex,t._columnViewportIndex),y=i.getViewportLeftColumn(t._columnViewportIndex),p=i.getViewportTopRow(t._rowViewportIndex),e;t._columnViewportIndex===0?e=t._absLocation.x+t._getActualWidth():t._columnViewportIndex===1?e=t._absLocation.x+t._getActualWidth()-i.getViewportWidth(0):t._columnViewportIndex===2&&(e=t._absLocation.x+t._getActualWidth()-(i.getViewportWidth(0)+i.getViewportWidth(1)));t._rowViewportIndex===0?o=t._absLocation.y+t._getActualHeight():t._rowViewportIndex===1?o=t._absLocation.y+t._getActualHeight()-i.getViewportHeight(0):t._rowViewportIndex===2&&(o=t._absLocation.y+t._getActualHeight()-(i.getViewportHeight(0)+i.getViewportHeight(1)));var s=new n.Point(e,o),h=0,c=0;for(r=y;r<i.getColumnCount();r++)if(l=i.getColumnWidth(r,3)*f,h+l<s.x)h+=l;else{t._endColumn=r;t._endColumnOffset=(s.x-h)/f;break}for(u=p;u<i.getRowCount();u++)if(a=i.getRowHeight(u,3)*f,c+a<s.y)c+=a;else{t._endRow=u;t._endRowOffset=(s.y-c)/f;break}}},o.prototype.addRows=function(n,t){var i=this,r=i._comment;n<=i._startRow?r.dynamicMove()&&(i._startRow+=t,i._endRow+=t):n>i._startRow&&n<=i._endRow&&r.dynamicSize()&&(i._endRow+=t);i._updateSizeByCoordinate();i._updateLocationByCoordinate()},o.prototype.addColumns=function(n,t){var i=this,r=i._comment;n<=i._startColumn?r.dynamicMove()&&(i._startColumn+=t,i._endColumn+=t):n>i._startColumn&&n<=i._endColumn&&r.dynamicSize()&&(i._endColumn+=t);i._updateSizeByCoordinate();i._updateLocationByCoordinate()},o.prototype.removeRows=function(n,t){var i=this,r=i._comment,u=n+t-1;n<i._startRow?u<i._startRow?r.dynamicMove()&&(i._startRow-=t,i._endRow-=t):u<i._endRow&&r.dynamicMove()&&(i._endRow-=r.dynamicSize()?t:i._startRow-n+1,i._startRow=n,i._startRowOffset=0):n<=i._endRow&&(u<i._endRow?r.dynamicSize()&&(i._endRow-=t):r.dynamicSize()&&(i._endRow=n,i._endRowOffset=0));i._updateSizeByCoordinate();i._updateLocationByCoordinate()},o.prototype.removeColumns=function(n,t){var i=this,r=i._comment,u=n+t-1;n<i._startColumn?u<i._startColumn?r.dynamicMove()&&(i._startColumn-=t,i._endColumn-=t):u<i._endColumn&&r.dynamicMove()&&(i._endColumn-=r.dynamicSize()?t:i._startColumn-n+1,i._startColumn=n,i._startColumnOffset=0):n<=i._endColumn&&(u<i._endColumn?r.dynamicSize()&&(i._endColumn-=t):r.dynamicSize()&&(i._endColumn=n,i._endColumnOffset=0));i._updateSizeByCoordinate();i._updateLocationByCoordinate()},o.prototype.updateLayout=function(){var t=this,r=t._comment,i=r._sheet;t.isOpen()&&(t._zoomFactor!==i._zoomFactor?(t._zoomFactor=i._zoomFactor,t._absLocation=t._getLocationByCoordinate()):t._zoomFactor=i._zoomFactor,t._updateCommentViewportIndex(),t._updateIndicatorSize(),t._formatComment(),t._updateLineContainerLayout(),t._updateAdornerLayout(),n.util.browser.chrome&&t._offsetCommentLayoutInChrome(),r.autoSize()&&!t._isAutosizing&&t._doAutosize())},o.prototype._updateIndicatorSize=function(){var n=this,t=n._comment._sheet,i=t.parent&&t.parent.useTouchLayout();n._hostMargin=i?11:7},o.prototype._updateCommentViewportIndex=function(){var e=this,t=e._comment,n=t&&t._sheet,i=t._rowIndex,r=t._colIndex,u=1,f=1,o=n.frozenRowCount,s=n.frozenColCount,h=n._frozenTrailingRowCount,c=n._frozenTrailingColCount,l=n.getRowCount(),a=n.getColumnCount();i<o?u=0:i>=o&&i<=l-h-1?u=1:i>l-h-1&&(u=2);r<s?f=0:r>=s&&r<=a-c-1?f=1:r>a-c-1&&(f=2);e._rowViewportIndex=u;e._columnViewportIndex=f},o.prototype._formatComment=function(){var n=this,i=n._comment,t=i.commentState()===2?n._editor:n._host;n._formatCommentState();n._formatCommentStyle(t);n._formatCommentText(t);n._formatCommentRect(t);n._formatCommentProtection()},o.prototype._formatCommentText=function(n){var t=this,i=t._comment;n===t._host&&(n.innerHTML=i.text().replace(/\r\n|\n|\r/g,"<br/>"))},o.prototype._formatCommentRect=function(t){var i=this,e=i._comment,it=e&&e._sheet,v=i._absLocation,g=i._zoomFactor,l,y,p,w,b,k,d;if(v){l=i._isResizing?i._getAdjustedCommentRect(v,e.width(),e.height()):i._getAdjustedCommentRect(v);i._adjustCommentRect(l);var o=l.width*g,s=l.height*g,h=l.x,c=l.y,nt=h+o,tt=c+s,a=i._hostMargin,f=i._getViewportRect(i._rowViewportIndex,i._columnViewportIndex);h<f.x?(n.GC$(i._floatBlockCanvas).css("left",h-f.x),n.GC$(i._hostContainer).css("left",h+a-f.x),o+=h-f.x,h=f.x):(n.GC$(i._floatBlockCanvas).css("left",0),n.GC$(i._hostContainer).css("left",a),nt>f.x+f.width&&(o+=f.x+f.width-1-nt));o=u(f.width-1,o);c<f.y?(n.GC$(i._floatBlockCanvas).css("top",c-f.y),n.GC$(i._hostContainer).css("top",c+a-f.y),s+=c-f.y,c=f.y):(n.GC$(i._floatBlockCanvas).css("top",0),n.GC$(i._hostContainer).css("top",a),tt>f.y+f.height&&(s+=f.y+f.height-1-tt));s=u(f.height-1,s);n.GC$(i._floatBlockCanvasContainer).css({left:h,top:c,width:o,height:s});y=o;p=s;n.DPIHelper.setSize(i._floatBlockCanvas,y,p);w=r(0,y-2*(a+e.borderWidth()));b=r(0,p-2*(a+e.borderWidth()));n.GC$(i._hostContainer).css({width:w,height:b});k=w;d=b;e.padding()&&(k-=parseInt(e.padding().left)+parseInt(e.padding().right),d-=parseInt(e.padding().top)+parseInt(e.padding().bottom));n.GC$(t).css({width:r(0,k),height:r(0,d)})}},o.prototype._adjustCommentRect=function(t){var r=this,i=r._comment,f=r._absLocation;if(t.x!==f.x||t.y!==f.y||t.width!==i.width()||t.height!==i.height()){var u=r._convertAbsLocationToRelLocation(new n.Point(t.x,t.y)),e=t.width,o=t.height;(u.x!==i.location().x||u.y!==i.location().y)&&(i._location=u);e!==i.width()&&(i._width=e);o!==i.height()&&(i._height=o);r._absLocation=new n.Point(t.x,t.y)}},o.prototype._formatCommentProtection=function(){var n=this,t=n._comment,i=t&&t._sheet;i.canEditComment()?(n._attachFloatBlockCanvasEventHandler(),n._attachHostContainerEventHandler(),n._attachLineCanvasEventHandler(),n._attachHostEventHandler(),n._attachEditorEventHandler()):(t.locked()?(n._detachFloatBlockCanvasEventHandler(),n._attachMouseWheelEvent(n._floatBlockCanvas),n._detachHostContainerEventHandler(),n._attachMouseWheelEvent(n._hostContainer),n._floatBlockCanvas.style.cursor="default",n._hostContainer.style.cursor="default"):(n._attachFloatBlockCanvasEventHandler(),n._attachHostContainerEventHandler()),t.lockText()?(n._detachHostEventHandler(),n._attachMouseWheelEvent(n._host),n._detachEditorEventHandler(),n._attachMouseWheelEvent(n._editor),(t.locked()||t.commentState()!==1)&&t.commentState(3),n._host.style.cursor=t.locked()?"default":"move"):(n._attachHostEventHandler(),n._attachEditorEventHandler()),n._attachLineCanvasEventHandler())},o.prototype._formatCommentState=function(){var r=this,u=r._comment,f=r._commentManager,i=u&&u._sheet;switch(u.commentState()){case 1:f.activateComment(u);r.isEditing()&&r.detachEditor();i.getSelections().length>0&&i._saveAndClearSheetSelections();n.FocusHelper.setActiveElement(i);break;case 2:f.activateComment(u);r.isEditing()||r._attachEditor();i.getSelections().length>0&&i._saveAndClearSheetSelections();n.FocusHelper.setActiveElement(t);break;case 3:u===f.getActiveComment()&&(f.deactivateComment(),i.getSelections().length===0&&i._loadAndSetSheetSelections());break}},o.prototype._formatCommentStyle=function(t){var r=this,i=r._comment,u=n.GC$(t),f;u.css("font-family",i.fontFamily()).css("font-style",i.fontStyle()).css("font-size",parseInt(i.fontSize())*r._zoomFactor+"pt").css("font-weight",i.fontWeight());u.css("text-decoration",n.StyleHelper.composeTextDecoration(i.textDecoration()));u.css("text-align",n.HorizontalAlign[i.horizontalAlign()]);i.padding()?u.css("padding",i.padding().toString()):u.css("padding","0px");u.css("background-color",i.backColor()).css("color",i.foreColor()).css("opacity",i.opacity());n.GC$(r._hostContainer).css("border-width",i.borderWidth()).css("border-style",i.borderStyle()).css("border-color",i.borderColor());f=r._commentManager.getCommentActualZIndex(i);n.GC$(r._lineCanvasContainer).css("z-index",f);n.GC$(r._floatBlockCanvasContainer).css("z-index",f)},o.prototype._offsetCommentLayoutInChrome=function(){var u=this,r=this._comment._sheet,t=n.GC$(u._hostContainer);if(r&&t){var i=r._eventHandler._getCanvasOffset(),f=i.left-Math.floor(i.left)>=.5?.5:0,e=i.top-Math.floor(i.top)>=.5?.5:0;t.css("left",parseFloat(t.css("left"))+f);t.css("top",parseFloat(t.css("top"))+e)}},o.prototype._updateLineContainerLayout=function(){var r=this,w=r._comment,k=w._sheet,b=r._getCellRect(k,w._rowIndex,w._colIndex,r._rowViewportIndex,r._columnViewportIndex),d=k._getSheetLayout(),f=t,tt=b.x+b.width-d.rowHeaderWidth,it=b.y-d.colHeaderHeight;f=new n.Point(tt,it);var e=t,o=n.GC$(r._floatBlockCanvasContainer).position(),s=n.GC$(r._hostContainer).position(),y=n.GC$(r._hostContainer);e=o.left+s.left>f.x?new n.Point(o.left+s.left,o.top+s.top):o.top+s.top+y.height()<f.y?new n.Point(o.left+s.left+y.width(),o.top+s.top+y.height()):new n.Point(o.left+s.left+y.width(),o.top+s.top);var p=r._hostMargin,c=h(f.x-e.x)+2*p,l=h(f.y-e.y)+2*p,a=u(f.x,e.x)-p,v=u(f.y,e.y)-p,g=a+c,nt=v+l,i=r._getViewportRect(r._rowViewportIndex,r._columnViewportIndex);a<i.x&&(c-=i.x-a,a=i.x);g>i.x+i.width&&(c-=g-(i.x+i.width));c=u(i.width,c);v<i.y&&(l-=i.y-v,v=i.y);nt>i.y+i.height&&(l-=nt-(i.y+i.height));l=u(i.height,l);n.GC$(r._lineCanvasContainer).css("left",a).css("top",v).css("width",c).css("height",l);n.DPIHelper.setSize(r._lineCanvas,c,l);f.x=f.x-a;f.y=f.y-v;e.x=e.x-a;e.y=e.y-v;r._drawLine(f,e)},o.prototype._drawLine=function(t,i){var u=this,r,f,e;u._lineCtx||(u._lineCtx=u._lineCanvas.getContext("2d"));r=u._lineCtx;f=u._comment.borderColor();r.strokeStyle=f;r.clearRect(0,0,n.DPIHelper.getLogicWidth(u._lineCanvas),n.DPIHelper.getLogicHeight(u._lineCanvas));r.beginPath();r.moveTo(t.x,t.y);r.lineTo(i.x,i.y);r.stroke();r.save();r.translate(t.x,t.y);r.fillStyle=f;r.beginPath();e=p(i.y-t.y,i.x-t.x);r.rotate(e);r.moveTo(0,0);r.lineTo(7,-4);r.lineTo(7,4);r.lineTo(0,0);r.fill();r.closePath();r.restore()},o.prototype._updateAdornerLayout=function(){var t=this,f=t._comment,h=f._sheet;t._adornerDrawState=t._comment.commentState();t._adornerCtx||(t._adornerCtx=t._floatBlockCanvas.getContext("2d"));var i=t._adornerCtx,r=n.DPIHelper.getLogicWidth(t._floatBlockCanvas),u=n.DPIHelper.getLogicHeight(t._floatBlockCanvas),e=n.GC$(t._hostContainer).outerWidth(),o=n.GC$(t._hostContainer).outerHeight(),s=t._hostMargin;i.clearRect(0,0,r,u);t._comment.showShadow()&&(t._drawShadowAdorner(i,s,e,o),t._drawStateAdorner(i,r,u));h.canEditComment(f)&&t._drawResizeAdorner(i,s,r,u,e,o);i.restore()},o.prototype._drawShadowAdorner=function(n,t,i,r){n.fillRect(t+2,t+2,i,r)},o.prototype._drawStateAdorner=function(n,t,i){var u,r;switch(this._adornerDrawState){case 1:for(n.beginPath(),u=0;u<i;u++)for(r=u%2==0?1:3;r<t;)n.moveTo(r,u),n.lineTo(r+1,u+1),r=r+4;n.stroke();n.closePath();break;case 2:n.beginPath();for(var r=0,u=0,f=4;r<t+i;)n.moveTo(r+f,0),n.lineTo(0,u+f),r=r+f,u=u+f;n.stroke();n.closePath();break;default:}},o.prototype._drawResizeAdorner=function(i,r,u,f,e,o){var h=this,c,l,a,v,y,p,w,b;(h._adornerDrawState===1||h._adornerDrawState===2)&&(h._resizeHitRects.splice(0,h._resizeHitRects.length),c=new n.Rect(0,0,r,r),h._resizeHitRects.push(c),l=new n.Rect(u-r,0,r,r),h._resizeHitRects.push(l),a=new n.Rect(0,f-r,r,r),h._resizeHitRects.push(a),v=new n.Rect(u-r,f-r,r,r),h._resizeHitRects.push(v),o>=3*r?(y=new n.Rect(0,s(f/2-r/2),r,r),h._resizeHitRects.push(y),p=new n.Rect(u-r,s(f/2-r/2),r,r),h._resizeHitRects.push(p)):(h._resizeHitRects.push(t),h._resizeHitRects.push(t)),e>=3*r?(w=new n.Rect(s(u/2-r/2),0,r,r),h._resizeHitRects.push(w),b=new n.Rect(s(u/2-r/2),f-r,r,r),h._resizeHitRects.push(b)):(h._resizeHitRects.push(t),h._resizeHitRects.push(t)),i.save(),i.fillStyle="white",i.strokeStyle="#939393",i.linewidth=1,i.translate(.5,.5),n.GC$.each(h._resizeHitRects,function(){if(h){var n=this,t=n.x,r=n.y,u=n.width,f=n.height;i.beginPath();i.fillRect(t,r,u-1,f-1);i.strokeRect(t,r,u-1,f-1);i.stroke();i.closePath()}}))},o.prototype._drawMoveResizeContainer=function(){var t=this,f=t._commentManager;t._moveResizeContainerDom?n.GC$(t._moveResizeContainerDom).remove():t._moveResizeContainerDom=document.createElement("div");t._moveResizePanelDom?n.GC$(t._moveResizePanelDom).remove():t._moveResizePanelDom=document.createElement("div");var r=n.GC$(t._moveResizePanelDom),e=n.GC$(t._moveResizeContainerDom),o=f._mouseCapture,u=n.GC$(t._hostContainer),i=t._getViewportRect(t._rowViewportIndex,t._columnViewportIndex);r.css({position:"absolute",overflow:"hidden",top:i.y,left:i.x,width:i.width,height:i.height,background:"rgba(255,255,255,0.01)"}).css("z-index",901).bind("mousemove",function(n){t._doMouseMove(n)}).bind("mouseup",function(n){t._doMouseUp(n)});e.addClass("gc-spread-moveResizeContainer").css("position","absolute").css("left",t._absLocation.x+t._hostMargin-i.x).css("top",t._absLocation.y+t._hostMargin-i.y).css("width",u.outerWidth()-2).css("height",u.outerHeight()-2).css("border","gray solid thin");r.append(t._moveResizeContainerDom);t._commentLayoutPanel&&t._commentLayoutPanel.appendChild(t._moveResizePanelDom)},o.prototype._doMoveResizeContainer=function(t){var i=this,a=i._comment,y=a&&a._sheet,k=i._absLocation,o=i._hostMargin,c=i._zoomFactor,p=y._commentManager,e=p._mouseCapture,s,l,r,h;if(e.capture){var v=i._getViewportScrollOffset(),u=t.pageX/c-e.x+v.x,f=t.pageY/c-e.y+v.y;if(u===0&&f===0)return;if(s=i._getViewportRect(i._rowViewportIndex,i._columnViewportIndex),l=n.GC$(i._moveResizeContainerDom),e.resizeDirct==-100){var w=e.cachedRect.x+u,b=e.cachedRect.y+f,h=i._convertRelLocationToAbsLocation(new n.Point(w,b));l.css("left",h.x+o-s.x).css("top",h.y+o-s.y)}else{switch(e.resizeDirct){case 0:r=i._getCommentTopLeftResizeRect(u,f);break;case 1:r=i._getCommentTopRightResizeRect(u,f);break;case 2:r=i._getCommentBottomLeftResizeRect(u,f);break;case 3:r=i._getCommentBottomRightResizeRect(u,f);break;case 4:r=i._getCommentMiddleLeftResizeRect(u);break;case 5:r=i._getCommentMiddleRightResizeRect(u);break;case 6:r=i._getCommentTopCenterResizeRect(f);break;case 7:r=i._getCommentBottomCenterResizeRect(f);break}h=i._convertRelLocationToAbsLocation(new n.Point(r.x,r.y));l.css("left",h.x+o-s.x).css("top",h.y+o-s.y).css("width",r.width*c-2*o-2).css("height",r.height*c-2*o-2)}}},o.prototype._attachEditor=function(){var t=this,r=t._comment,i;t.isEditing()||(i=t._commentManager._editorDom,n.GC$(t._host).remove(),t._detachHostEventHandler(),n.GC$(i).remove(),n.GC$(t._hostContainer).append(i),t._setDomStyle(i),t._formatCommentRect(i),n.GC$(i).focus(),i.selectionStart=i.value.length,t._attachEditorEventHandler(),r.commentState()!==2&&r.commentState(2))},o.prototype.detachEditor=function(){var t=this,i=t._comment,u=i._sheet,r,f;t.isEditing()&&(r=t._commentManager._editorDom,n.GC$(r).remove(),t._detachEditorEventHandler(),n.GC$(t._hostContainer).append(t._host),t._setDomStyle(t._host),t._attachHostEventHandler(),n.features.touch&&(t._touchContentManager=new n.CommentContentTouchManager(t._host,t,u.parent._touchEventProvider),t._touchContentManager.attach()),i.commentState()===2&&i.commentState(3),n.GC$(r).val()!==i.text()&&(f=new n.UndoRedo.CommentPropertyUndoAction(u,i,i.text(),n.GC$(r).val(),"text"),u._doCommand(f)))},o.prototype._getSheetHeight=function(n,r){var o=this,u,e,f;if(n===t||n===i)return-1;for(u=0,e=n.getRowCount(),f=0;f<e;f++)if(u+=n.getRowHeight(f,3),u>r)break;return u},o.prototype._getSheetWidth=function(n,r){var u,e,f;if(n===t||n===i)return-1;for(u=0,e=n.getColumnCount(),f=0;f<e;f++)if(u+=n.getColumnWidth(f,3),u>r)break;return u},o.prototype._getViewportHeight=function(n){var r=this,u=r._comment,t=u&&u._sheet,i;if(n===0||n===2)return t.getViewportHeight(n);else if(n===1){var e=t.getViewportBottomRow(0)+1,o=t.getViewportTopRow(2),f=0;for(i=e;i<=o;i++)f+=t.getRowHeight(i,3)*r._zoomFactor;return f}return-1},o.prototype._getViewportWidth=function(n){var r=this,u=r._comment,t=u&&u._sheet,i;if(n===0||n===2)return t.getViewportWidth(n);else if(n===1){var e=t.getViewportRightColumn(0)+1,o=t.getViewportLeftColumn(2),f=0;for(i=e;i<=o;i++)f+=t.getColumnWidth(i,3)*r._zoomFactor;return f}return-1},o.prototype._getTwoColumnDistance=function(n,t,i){for(var o=u(t,i),s=r(t,i),e=0,f=o;f<s;f++)e+=n.getColumnWidth(f,3)*this._zoomFactor;return e},o.prototype._getTwoRowDistance=function(n,t,i){for(var o=u(t,i),s=r(t,i),e=0,f=o;f<s;f++)e+=n.getRowHeight(f,3)*this._zoomFactor;return e},o.prototype._getViewportRect=function(t,i){var f=this,e=f._comment,o=e._sheet,s=f._commentManager,h=s.getCommentView(e),r=o._getSheetLayout(),u=new n.Rect(0,0,0,0);return u=r.viewportRect(t,i),t===0&&i===0||t===0&&i===2||t===2&&i===0||t===2&&i===2?(u.x=0,u.y=0,u.width=r.frozenWidth+r.viewportWidth+r.frozenTrailingWidth,u.height=r.frozenHeight+r.viewportHeight+r.frozenTrailingHeight):t===0&&i===1||t===2&&i===1?(u.x=r.frozenWidth,u.y=0,u.width=r.viewportWidth,u.height=r.frozenHeight+r.viewportHeight+r.frozenTrailingHeight):t===1&&i===0||t===1&&i===2?(u.x=0,u.y=r.frozenHeight,u.width=r.frozenWidth+r.viewportWidth+r.frozenTrailingWidth,u.height=r.viewportHeight):t===1&&i===1&&(u.x=r.frozenWidth,u.y=r.frozenHeight,u.width=r.viewportWidth,u.height=r.viewportHeight),u},o.prototype._setDomStyle=function(t){var r=this,i=r._comment,u=n.GC$(t);(t===r._editor||t===r._host)&&(t===r._editor?t.value=i.text():t.innerHTML=i.text().replace(/\r\n|\n|\r/g,"<br/>"),u.css("font-family",i.fontFamily()).css("font-style",i.fontStyle()).css("font-size",i.fontSize()).css("font-weight",i.fontWeight()).css("color",i.foreColor()).css("background-color",i.backColor()).css("text-align",i.horizontalAlign()).css("text-decoration",i.textDecoration()),i.padding()?u.css("padding",i.padding().toString()):u.css("padding","0px"))},o.prototype.isOpen=function(){var n=this;return n._floatBlockCanvasContainer&&n._floatBlockCanvasContainer.parentNode?!0:!1},o.prototype.isActive=function(){var n=this;return n.isOpen()&&n._comment===n._commentManager.getActiveComment()?!0:!1},o.prototype.isEditing=function(){var t=this;return t.isActive()?n.GC$(t._hostContainer).find("textarea").length()>0:!1},o.prototype.getCommentRect=function(){var i=this,u=i._comment,e=u&&u._sheet,o=i._zoomFactor,f=t,r;return i.isOpen()&&(r=i._comment._sheet._getSheetLayout(),f=new n.Rect(i._absLocation.x+r.headerX+r.rowHeaderWidth,i._absLocation.y+r.headerY+r.colHeaderHeight,i._getActualWidth(),i._getActualHeight())),f},o.prototype.getCommentEditAreaRect=function(){var i=this,u=i._comment,a=u&&u._sheet,o=i._zoomFactor,r,s,h,c,l,f,e;return i.isOpen()&&(r=i.getCommentRect(),r)?(f=(i._hostMargin+u.borderWidth())*o,e=(i._hostMargin+u.borderWidth())*o,s=r.x+f,h=r.y+e,c=r.width-2*f,l=r.height-2*e,new n.Rect(s,h,c,l)):t},o.prototype._setCursorState=function(n){var i=this,r=i._comment,u=r._sheet,t=n.target,f=i._commentManager._mouseCapture,e;if(f.capture){(t.className===i._hostClassName||t.className===i._floatBlockCanvasClassName||t.className===i._lineCanvasClassName||t.className==="gc-spread-floatPanel")&&(t.style.cursor=f.resizeDirct>=0?"crosshair":"move");return}else{if(t.className===i._hostClassName)if(!u.canEditComment()&&r.lockText()){t.style.cursor=r.locked()?"default":"move";return}else{t.style.cursor="text";return}if(t.className===i._floatBlockCanvasClassName||t.className===i._hostContainerClassName)if(u.canEditComment(r)){e=i._getResizeDirection(n);switch(e){case 0:t.style.cursor="nw-resize";return;case 1:t.style.cursor="ne-resize";return;case 2:t.style.cursor="sw-resize";return;case 3:t.style.cursor="se-resize";return;case 4:t.style.cursor="w-resize";return;case 5:t.style.cursor="e-resize";return;case 6:t.style.cursor="n-resize";return;case 7:t.style.cursor="s-resize";return;default:t.style.cursor="move";return}}else{t.style.cursor="default";return}}t.style.cursor="default"},o.prototype._doMouseDownToEdit=function(t){var i=this,r=i._comment,u=r&&r._sheet;if(u.endEdit()){if(u.unSelectAllFloatingObjects(),i._touchContentManager&&!t.isTouch&&i._touchContentManager.preProcessMouseDown(t)){n.util.cancelDefault(t);return}return i._commentManager.activateComment(r),r.commentState(2),i._doMouseUp(t),n.util.cancelDefault(t)}},o.prototype._doMouseDownToDragOrResize=function(t){var i=this,r=i._comment,u=r&&r._sheet,h=i._zoomFactor,c=i._commentManager,f=c._mouseCapture;if(u.endEdit()){if(u.unSelectAllFloatingObjects(),i._touchManager&&!t.isTouch&&i._touchManager.preProcessMouseDown(t)){n.util.cancelDefault(t);return}f.x=t.pageX/h;f.y=t.pageY/h;f.cachedRect=new n.Rect(r.location().x,r.location().y,r.width(),r.height());f.resizeDirct=i._getResizeDirection(t);i._handleDocumentMouseMove();f.capture=!0;i._setCursorState(t);c.activateComment(r);r.commentState(1);u.canEditComment(r)&&(i._moveInfo={},i._moveInfo.startTopRow=u.getViewportTopRow(i._rowViewportIndex),i._moveInfo.startLeftColumn=u.getViewportLeftColumn(i._columnViewportIndex),i._drawMoveResizeContainer(),f.resizeDirct===-100?i._isMoving=!0:i._isResizing=!0);var e=u._eventHandler,l=e._getCanvasOffset(),o=new n.Point(t.pageX-l.left,t.pageY-l.top),s=u.hitTest(o.x,o.y);e.startHitInfo={scrollRowViewportIndex:s.rowViewportIndex,scrollColViewportIndex:s.colViewportIndex,hitTestType:s.hitTestType};e.mousePosition=o;e.startScroll();e.isCommentWorking=!0;t.stopPropagation()}},o.prototype._getAdjustedCommentRect=function(t,i,r){var u=this,b=u._comment,o=b&&b._sheet,p=u._hostMargin,vt=u._commentManager,it=u._zoomFactor,k=u._columnViewportIndex,d=u._rowViewportIndex,ft=u._getViewportRect(d,k),a,g,ot,st,ht,ct,lt,at,rt;arguments.length===1?(a=u._getActualWidth(),g=u._getActualHeight()):arguments.length===3&&(a=i*it,g=r*it);var f=t.x,v=t.y,tt=o._getSheetLayout(),et=u._getCellRect(o,0,0,d,k),w=t.x+(0-(et.x-tt.rowHeaderWidth))+a-p,nt=t.y+(0-(et.y-tt.colHeaderHeight))+g-p,e,c,l,y;if(k===0?(e=0-p,l=tt.width-tt.rowHeaderWidth):k===1?(ot=u._getTwoColumnDistance(o,o.getViewportRightColumn(0)+1,o.getViewportLeftColumn(1)),e=ft.x-p-ot,st=u._getViewportWidth(2),l=-st):k===2&&(e=0-p,l=0),f<e&&(u._isResizing?a-=e-f:w+=e-f,f=e),(k===1||k===2)&&(l+=u._getSheetWidth(o,w)),w>l)if(u._isResizing)a-=w-l;else if(u._isMoving)f-=w-l;else{var s=0,yt=b===vt.getHoverShownComment()?b._defaultLocation.x:b.location().x,ut=2*h(yt)+o.getColumnWidth(b._colIndex)+b.width();s=f-ut;s>e?f=s:f<l?a-=w-l:(s=f-ut,ht=w-ut,ht>e?s<e?(a-=e-s,f=e):f=s:(s=f-(w-l),s<e?(a-=e-s,f=e):f=s))}return d===0?(c=0-p,y=tt.height-tt.colHeaderHeight):d===1?(ct=u._getTwoRowDistance(o,o.getViewportBottomRow(0)+1,o.getViewportTopRow(1)),c=ft.y-p-ct,lt=u._getViewportHeight(2),y=lt):d===2&&(c=0-p,y=0),v<c&&(u._isResizing?g-=c-v:nt+=c-v,v=c),(d===1||d===2)&&(y+=u._getSheetHeight(o,nt)),nt>y&&(u._isResizing?g-=nt-y:u._isMoving?v-=nt-y:nt>y&&(at=nt-y,rt=v-at,rt<c?(g-=c-rt,v=c):v=rt)),new n.Rect(f,v,a/it,g/it)},o.prototype._getViewportScrollOffset=function(){var t=this,i=t._comment._sheet,r,u,f=t._moveInfo.startTopRow,e=t._moveInfo.startLeftColumn,o=i.getViewportTopRow(t._rowViewportIndex),s=i.getViewportLeftColumn(t._columnViewportIndex),h=t._getTwoRowDistance(i,f,o),c=t._getTwoColumnDistance(i,e,s);return r=e<s?c:-c,u=f<o?h:-h,new n.Point(r,u)},o.prototype._doMoveResizeComment=function(t){var i=this,r=i._comment,s=r&&r._sheet,a=i._zoomFactor,p=s._commentManager,h=p._mouseCapture,u;if(h.capture){var v=i._getViewportScrollOffset(),f=t.pageX/a-h.x+v.x,e=t.pageY/a-h.y+v.y;if(f===0&&e===0)return;if(h.resizeDirct==-100){var w=h.cachedRect.x+f,b=h.cachedRect.y+e,y=i._convertRelLocationToAbsLocation(new n.Point(w,b)),o=i._getAdjustedCommentRect(y),c=i._convertAbsLocationToRelLocation(new n.Point(o.x,o.y));(c.x!==r.location().x||c.x!==r.location().y)&&s._doCommand(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.location().clone(),c,"location"))}else{r._autoSize=!1;switch(h.resizeDirct){case 0:u=i._getCommentTopLeftResizeRect(f,e);break;case 1:u=i._getCommentTopRightResizeRect(f,e);break;case 2:u=i._getCommentBottomLeftResizeRect(f,e);break;case 3:u=i._getCommentBottomRightResizeRect(f,e);break;case 4:u=i._getCommentMiddleLeftResizeRect(f);break;case 5:u=i._getCommentMiddleRightResizeRect(f);break;case 6:u=i._getCommentTopCenterResizeRect(e);break;case 7:u=i._getCommentBottomCenterResizeRect(e);break}var y=i._convertRelLocationToAbsLocation(new n.Point(u.x,u.y)),o=i._getAdjustedCommentRect(y,u.width,u.height),c=i._convertAbsLocationToRelLocation(new n.Point(o.x,o.y)),l=new n.UndoRedo.CommentUndoTransaction;(c.x!==r.location().x||c.y!==r.location().y)&&l.add(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.location().clone(),c,"location"));o.width!==r.width()&&l.add(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.width(),o.width,"width"));o.height!==r.height()&&l.add(new n.UndoRedo.CommentPropertyUndoAction(s,r,r.height(),o.height,"height"));s._doCommand(l)}}},o.prototype._doMouseMove=function(t){var i=this,u=i._comment._sheet;if(this._setCursorState(t),!u.getSelections()||!(u.getSelections().length>0)){if(i._touchManager&&!t.isTouch&&i._touchManager.preProcessMouseMove(t)){n.util.cancelDefault(t);return}if(i._touchContentManager&&!t.isTouch&&i._touchContentManager.preProcessMouseMove(t)){n.util.cancelDefault(t);return}var o=i._commentManager,s=t.target,r=u._eventHandler,f=r._getCanvasOffset(),e=new n.Point(t.pageX-f.left,t.pageY-f.top);return s&&o._mouseCapture.capture&&(i._moveResizeContainerDom&&i._doMoveResizeContainer(t),i._rowViewportIndex===1&&(r.mousePosition.y=e.y),i._columnViewportIndex===1&&(r.mousePosition.x=e.x),r.continueScroll()),n.util.cancelDefault(t)}},o.prototype._doMouseUp=function(t){var i=this,r=i._comment._sheet;if(!r.getSelections()||!(r.getSelections().length>0)){if(i._touchManager&&!t.isTouch&&i._touchManager.preProcessMouseUp(t)){n.util.cancelDefault(t);return}if(i._touchContentManager&&!t.isTouch&&i._touchContentManager.preProcessMouseUp(t)){n.util.cancelDefault(t);return}var f=t.target,e=i._commentManager,u=r._eventHandler;return u.isCommentWorking=!1,u.stopScroll(),f&&(i._doMoveResizeComment(t),i._moveResizePanelDom&&(n.GC$(i._moveResizePanelDom).remove(),i._moveResizePanelDom=null,i._isMoving=!1,i._isResizing=!1),i._unhandleDocumentMouseMove(),e._mouseCapture.capture=!1,i._setCursorState(t)),n.util.cancelDefault(t)}},o.prototype._getResizeDirection=function(t){var r=this;if(r._resizeHitRects.length>0&&(r._adornerDrawState===1||r._adornerDrawState===2)){var e=t.target,u=t.pageX-n.GC$(e).offset().left,f=t.pageY-n.GC$(e).offset().top,i=r._resizeHitRects[0];if(i&&i.contains(u,f))return 0;if(i=r._resizeHitRects[1],i&&i.contains(u,f))return 1;if(i=r._resizeHitRects[2],i&&i.contains(u,f))return 2;if(i=r._resizeHitRects[3],i&&i.contains(u,f))return 3;if(i=r._resizeHitRects[4],i&&i.contains(u,f))return 4;if(i=r._resizeHitRects[5],i&&i.contains(u,f))return 5;if(i=r._resizeHitRects[6],i&&i.contains(u,f))return 6;if(i=r._resizeHitRects[7],i&&i.contains(u,f))return 7}return-100},o.prototype._getCommentTopLeftResizeRect=function(t,i){var r=this,f,e,o,s,u=r._commentManager._mouseCapture,h=u.cachedRect.width-2*r._hostMargin-t,c=u.cachedRect.height-2*r._hostMargin-i;return h>=0?(f=u.cachedRect.x+t,o=h+2*r._hostMargin):(f=u.cachedRect.x+u.cachedRect.width-2*r._hostMargin,o=-h+2*r._hostMargin),c>=0?(e=u.cachedRect.y+i,s=c+2*r._hostMargin):(e=u.cachedRect.y+u.cachedRect.height-2*r._hostMargin,s=-c+2*r._hostMargin),new n.Rect(f,e,o,s)},o.prototype._getCommentTopRightResizeRect=function(t,i){var r=this,e,o,s,h,u=r._commentManager._mouseCapture,f=u.cachedRect.width-2*r._hostMargin+t,c=u.cachedRect.height-2*r._hostMargin-i;return f>=0?(e=u.cachedRect.x,s=f+2*r._hostMargin):(e=u.cachedRect.x+f,s=-f+2*r._hostMargin),c>=0?(o=u.cachedRect.y+i,h=c+2*r._hostMargin):(o=u.cachedRect.y+u.cachedRect.height-2*r._hostMargin,h=-c+2*r._hostMargin),new n.Rect(e,o,s,h)},o.prototype._getCommentBottomLeftResizeRect=function(t,i){var r=this,e,o,s,h,u=r._commentManager._mouseCapture,c=u.cachedRect.width-2*r._hostMargin-t,f=u.cachedRect.height-2*r._hostMargin+i;return c>=0?(e=u.cachedRect.x+t,s=c+2*r._hostMargin):(e=u.cachedRect.x+u.cachedRect.width-2*r._hostMargin,s=-c+2*r._hostMargin),f>=0?(o=u.cachedRect.y,h=f+2*r._hostMargin):(o=u.cachedRect.y+f,h=-f+2*r._hostMargin),new n.Rect(e,o,s,h)},o.prototype._getCommentBottomRightResizeRect=function(t,i){var r=this,o,s,h,c,u=r._commentManager._mouseCapture,f=u.cachedRect.width-2*r._hostMargin+t,e=u.cachedRect.height-2*r._hostMargin+i;return f>=0?(o=u.cachedRect.x,h=f+2*r._hostMargin):(o=u.cachedRect.x+f,h=-f+2*r._hostMargin),e>=0?(s=u.cachedRect.y,c=e+2*r._hostMargin):(s=u.cachedRect.y+e,c=-e+2*r._hostMargin),new n.Rect(o,s,h,c)},o.prototype._getCommentMiddleLeftResizeRect=function(t){var r=this,u,o,f,s,i=r._commentManager._mouseCapture,e=i.cachedRect.width-2*r._hostMargin-t;return e>=0?(u=i.cachedRect.x+t,f=e+2*r._hostMargin):(u=i.cachedRect.x+i.cachedRect.width-2*r._hostMargin,f=-e+2*r._hostMargin),o=i.cachedRect.y,s=i.cachedRect.height,new n.Rect(u,o,f,s)},o.prototype._getCommentMiddleRightResizeRect=function(t){var r=this,f,o,e,s,i=r._commentManager._mouseCapture,u=i.cachedRect.width-2*r._hostMargin+t;return u>=0?(f=i.cachedRect.x,e=u+2*r._hostMargin):(f=i.cachedRect.x+u,e=-u+2*r._hostMargin),o=i.cachedRect.y,s=i.cachedRect.height,new n.Rect(f,o,e,s)},o.prototype._getCommentTopCenterResizeRect=function(t){var r=this,o,u,s,f,i=r._commentManager._mouseCapture,e=i.cachedRect.height-2*r._hostMargin-t;return o=i.cachedRect.x,s=i.cachedRect.width,e>=0?(u=i.cachedRect.y+t,f=e+2*r._hostMargin):(u=i.cachedRect.y+i.cachedRect.height-2*r._hostMargin,f=-e+2*r._hostMargin),new n.Rect(o,u,s,f)},o.prototype._getCommentBottomCenterResizeRect=function(t){var r=this,o,f,s,e,i=r._commentManager._mouseCapture,u=i.cachedRect.height-2*r._hostMargin+t;return o=i.cachedRect.x,s=i.cachedRect.width,u>=0?(f=i.cachedRect.y,e=u+2*r._hostMargin):(f=i.cachedRect.y+u,e=-u+2*r._hostMargin),new n.Rect(o,f,s,e)},o.prototype._attachMouseWheelEvent=function(t){var r=this,o=this._comment._sheet,i,u;if(t){i="";switch(t){case r._floatBlockCanvas:i=".floatBlockCanvas";case r._hostContainer:i=".hostContainer";case r._lineCanvasContainer:i=".lineCanvasContainer";case r._host:i=".host";case r._editor:i=".editor"}i&&(n.GC$(t).unbind(f+i).unbind(e+i),u=function(t){o._mouseWheelDelegate(t);n.util.cancelDefault(t)},n.GC$(t).bind(f+i,u).bind(e+i,u))}},o.prototype._attachFloatBlockCanvasEventHandler=function(){var t=this,r=t._comment,o=r&&r&&r._sheet,i,u;t._detachFloatBlockCanvasEventHandler();i=".floatBlockCanvas";u=function(n){o&&o._mouseWheelDelegate(n)};n.GC$(t._floatBlockCanvas).bind("mousedown"+i,function(n){t._doMouseDownToDragOrResize(n)}).bind("mousemove"+i,function(n){t._doMouseMove(n)}).bind("mouseup"+i,function(n){t._doMouseUp(n)}).bind(f+i,u).bind(e+i,u)},o.prototype._detachFloatBlockCanvasEventHandler=function(){var t=this;n.GC$(t._floatBlockCanvas).unbind(".floatBlockCanvas")},o.prototype._attachHostContainerEventHandler=function(){var t=this,u=t._comment,o=u&&u._sheet,i,r;t._detachHostContainerEventHandler();i=".hostContainer";r=function(n){o&&o._mouseWheelDelegate(n)};n.GC$(t._hostContainer).bind("mousedown"+i,function(n){t._doMouseDownToDragOrResize(n)}).bind("mousemove"+i,function(n){t._doMouseMove(n)}).bind("mouseup"+i,function(n){t._doMouseUp(n)}).bind(f+i,r).bind(e+i,r)},o.prototype._detachHostContainerEventHandler=function(){var t=this;n.GC$(t._hostContainer).unbind(".hostContainer")},o.prototype._attachLineCanvasEventHandler=function(){var i=this,s=i._comment,t=s&&s._sheet,o=t._commentManager;if(i._detachLineCanvasEventHandler(),t){var r=t._eventHandler._getCanvasOffset(),u=".lineCanvas",h=function(n){t._mouseWheelDelegate(n)};n.GC$(i._lineCanvas).bind("mousedown"+u,function(u){var h=t.hitTest(u.pageX-r.left,u.pageY-r.top),f=h.commentHitInfo,s,e;f?(s=f.comment,e=o.getCommentView(s),f.area==="editArea"?e._doMouseDownToEdit(u):f.area==="moveResizeArea"&&e._doMouseDownToDragOrResize(u),n.GC$(e._floatBlockCanvasContainer).css("z-index",parseInt(n.GC$(i._lineCanvasContainer).css("z-index")+1))):t._mouseDownDelegate(u)}).bind("mousemove"+u,function(n){var h=t.hitTest(n.pageX-r.left,n.pageY-r.top),u=h.commentHitInfo,e,s,f;u?(e=u.comment,s=o.getCommentView(e),s._doMouseMove(n),u.area==="editArea"?i._lineCanvas.style.cursor="text":u.area==="moveResizeArea"&&(i._lineCanvas.style.cursor="move")):(t._mouseMoveDelegate(n),f=t._getCanvas(),f&&(i._lineCanvas.style.cursor=f.style.cursor))}).bind("mouseup"+u,function(n){var e=t.hitTest(n.pageX-r.left,n.pageY-r.top),i=e.commentHitInfo,u,f;i?(u=i.comment,f=o.getCommentView(u),f._doMouseUp(n)):t._mouseUpDelegate(n)}).bind("dblclick"+u,function(n){t._dblClickDelegate(n)}).bind(f+u,h).bind(e+u,h)}},o.prototype._detachLineCanvasEventHandler=function(){var t=this;n.GC$(t._lineCanvas).unbind(".lineCanvas")},o.prototype._attachHostEventHandler=function(){var t=this,r=t._comment,o=r&&r._sheet,i,u;r.commentState()!==2&&t._host&&(t._detachHostEventHandler(),i=".host",u=function(n){o&&o._mouseWheelDelegate(n)},n.GC$(t._host).bind("mousedown"+i,function(n){t._doMouseDownToEdit(n)}).bind("mousemove"+i,function(n){t._doMouseMove(n)}).bind("mouseup"+i,function(n){t._doMouseUp(n)}).bind(f+i,u).bind(e+i,u))},o.prototype._detachHostEventHandler=function(){var t=this,i=t._comment;i.commentState()!==2&&t._host&&n.GC$(t._host).unbind(".host")},o.prototype._attachEditorEventHandler=function(){var r=this,i=r._comment,u=i&&i._sheet,s=r._editor,t,o;i.commentState()===2&&s&&(this._detachEditorEventHandler(),t=".editor",o=function(n){u&&u._mouseWheelDelegate(n)},n.GC$(s).bind("mousedown"+t,function(n){n.stopPropagation()}).bind("mousemove"+t,function(n){n.stopPropagation()}).bind("mouseup"+t,function(n){n.stopPropagation()}).bind(f+t,o).bind(e+t,o).bind("input"+t,function(n){i.autoSize()&&r._doAutosize()}).bind("keydown"+t,function(t){(t.keyCode===27||t.keyCode===9)&&(i.commentState(1),n.util.cancelDefault(t),n.FocusHelper.setActiveElement(u))}))},o.prototype._doAutosize=function(){var e=this,t=e._comment,a=t&&t._sheet,i,u,y,p,c,l,w,b,k;t.commentState()===2?(i=e._editor,u=i.value.split("\n")):(i=e._host,u=i.innerHTML.split("<br>"));var d=n.GC$(i).height(),g=n.GC$(i).width(),o,s,h=0,v=i.style,f="";if(v.font?(h=a._getFontHeight(v.font),f+=v.font):(t.fontStyle()&&(f+=" "+t.fontStyle()),t.fontWeight()&&(f+=" "+t.fontWeight()),t.fontSize()&&(f+=" "+t.fontSize()),t.fontFamily()&&(f+=" "+t.fontFamily()),h=a._getFontHeight(f)),y=h,p=5,u&&u.length>0){for(o=r(u.length*h,y),c=0,l=0;l<u.length;l++)w=a._getStringWidth(u[l],f),c<w&&(c=w);s=r(c,p)}else o=y,s=p;n.GC$(i).css("height",o).css("width",s);t.commentState()===2&&(t._text=i.value);e._isAutosizing=!0;b=o-d;b!==0&&t._changeProperty("height",t.height()+b);k=s-g;k!==0&&t._changeProperty("width",t.width()+k);e._isAutosizing=!1},o.prototype._detachEditorEventHandler=function(){var t=this,r=t._comment,i=t._editor;r.commentState()===2&&i&&n.GC$(i).unbind(".editor")},o.prototype._handleDocumentMouseMove=function(){var i=this,r=this._commentManager._mouseCapture,t;r.capture||(t=".gcComment",n.GC$(document).bind("mousemove"+t,function(n){i._doMouseMove(n)}).bind("mouseup"+t,function(n){i._doMouseUp(n)}),r.capture=!0)},o.prototype._unhandleDocumentMouseMove=function(){var t=this._commentManager._mouseCapture;t.capture&&(t.capture=!1,n.GC$(document).unbind(".gcComment"))},o}();n.CommentView=l;v=function(){function r(n){var i=this;i._sheet=n;i._mouseCapture={capture:!1,x:0,y:0,cachedRect:t,resizeDirct:-100};i._editorDom=t;i._hoverShowComment=t;i._activeComment=t;i._commentList=[];i._commentViewList=[];i.createEditDom();i._bindEventsOnSheet()}return r.prototype.createEditDom=function(){var t=document.createElement("textarea");n.GC$(t).addClass("gc-comment-editor").css("left",0).css("top",0).css("position","absolute").css("margin",0).css("padding",0).css("word-wrap","break-word").css("word-break","normal").css("overflow","hidden").css("resize","none").css("outline","none").css("border","0px").css("box-sizing","content-box").attr("autocomplete","off").attr("gcUIElement","gcEditingInput");this._editorDom=t},r.prototype.getCommentList=function(){for(var t=this,i=[],n=0;n<t._commentList.length;n++)i.push(t._commentList[n]);return i},r.prototype.getHoverShownComment=function(){return this._hoverShowComment},r.prototype._bindEventsOnSheet=function(){var t=this,i=t._sheet;i&&(i._bind(n.Events.ColumnChanged,function(n,i){var r=i.propertyName;(r==="width"||r==="isVisible")&&t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.RowChanged,function(n,i){var r=i.propertyName;(r==="height"||r==="isVisible")&&t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.ColumnWidthChanged,function(n,i){t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.RowHeightChanged,function(n,i){t._updateCommentsLayoutWhenRowColumnChanged()}),i._bind(n.Events.CommentChanged,function(n,i){var r=i&&i.propertyName,u=t.getCommentView(i.comment);u&&(r==="location"?u.updateLayoutWhenLocationChanged():(r==="width"||r==="height")&&u.updateLayoutWhenWidthHeightChanged())}))},r.prototype._addCommentView=function(t){var i=this;t&&n.ArrayHelper.indexOf(i._commentViewList,t)===-1&&this._commentViewList.push(t)},r.prototype._removeCommentView=function(t){this._commentViewList.splice(n.ArrayHelper.indexOf(this._commentViewList,t),1)},r.prototype.getCommentView=function(n){var i,r;if(!n)return t;for(i=0;i<this._commentViewList.length;i++)if(r=this._commentViewList[i],r.getComment()===n)return r;return t},r.prototype.hasComment=function(){return this._commentList.length>0},r.prototype.addComment=function(n,t,i){var r=this;i&&!r.containsComment(i)&&(i._sheet=r._sheet,i._rowIndex=n,i._colIndex=t,i._zIndex=898,r._updateCommentZIndex(),r._commentList.push(i),r._sheet.invalidate())},r.prototype._updateCommentZIndex=function(){for(var i=this,t=i._commentList,n=0;n<t.length;n++)t[n]._zIndex--},r.prototype._getTopCommentZIndex=function(){var n=this,t,i,r;if(n._commentList.length>0){for(t=n._commentList[0].zIndex(),i=1;i<n._commentList.length;i++)r=n._commentList[i],t<r.zIndex()&&(t=r.zIndex());return t}return 0},r.prototype.removeComment=function(t){var i=this,u=i._commentList,r;t&&(i.hideComment(t),u.splice(n.ArrayHelper.indexOf(u,t),1),r=i.getCommentView(t),r&&i._removeCommentView(r))},r.prototype.containsComment=function(t){var i=this;return n.ArrayHelper.indexOf(i._commentList,t)!==-1?!0:!1},r.prototype.clear=function(n,i,r,u){var h=this,f=h._sheet,c=f.isPaintSuspended(),e,o,s;for(f.isPaintSuspended(!0),e=0;e<r;e++)for(o=0;o<u;o++)s=f.getComment(e+n,o+i),s&&(h.removeComment(s),f.setComment(e+n,o+i,t));f.isPaintSuspended(c)},r.prototype.addRows=function(n,t){for(var r,u,f=this,e=f._commentList,o=f._commentViewList,i=0;i<e.length;i++)r=e[i],n<=r._rowIndex&&(r._rowIndex+=t);for(i=0;i<o.length;i++)u=o[i],u.isOpen()&&u.addRows(n,t)},r.prototype.addColumns=function(n,t){for(var r,u,f=this,e=f._commentList,o=f._commentViewList,i=0;i<e.length;i++)r=e[i],n<=r._colIndex&&(r._colIndex+=t);for(i=0;i<o.length;i++)u=o[i],u.isOpen()&&u.addColumns(n,t)},r.prototype.removeRows=function(n,t){for(var r,e,f=this,u=f._commentList,o=f._commentViewList,i=0;i<u.length;i++)r=u[i],r._rowIndex>=n&&r._rowIndex<n+t&&(f.removeComment(r),i--);for(i=0;i<u.length;i++)r=u[i],n<r._rowIndex&&(r._rowIndex-=t);for(i=0;i<o.length;i++)e=o[i],e.isOpen()&&e.removeRows(n,t)},r.prototype.removeColumns=function(n,t){for(var r,e,f=this,u=f._commentList,o=f._commentViewList,i=0;i<u.length;i++)r=u[i],r._colIndex>=n&&r._colIndex<n+t&&(f.removeComment(r),i--);for(i=0;i<u.length;i++)r=u[i],n<r._colIndex&&(r._colIndex-=t);for(i=0;i<o.length;i++)e=o[i],e.isOpen()&&e.removeColumns(n,t)},r.prototype.getActiveComment=function(){return this._activeComment},r.prototype.activateComment=function(n){var t=this;n&&n!==t._activeComment&&(t.deactivateComment(),t._activeComment=n)},r.prototype.deactivateComment=function(){var i=this,r=i._activeComment,n;r&&(n=i.getCommentView(r),!n||n._isMoving||n._isResizing||(n.isEditing()&&n.detachEditor(),r.commentState(3),i._activeComment=t))},r.prototype.showComment=function(n){var i=this,t;n&&(t=i.getCommentView(n),t||(t=new l(n,i),i._addCommentView(t)),t.open())},r.prototype.showAllComments=function(){for(var n=0;n<this._commentList.length;n++)this.showComment(this._commentList[n])},r.prototype.showCommentLayoutPanel=function(){var t=this._sheet;n.GC$(t._commentRender._commentLayoutPanel).show()},r.prototype.hideComment=function(n){var i=this,r=i.getCommentView(n);r&&r.isOpen()&&(r.close(),n===i._activeComment&&i._sheet._loadAndSetSheetSelections());clearTimeout(n._timeout);n._timeout=t},r.prototype.hideAllComments=function(){for(var n=0;n<this._commentList.length;n++)this.hideComment(this._commentList[n])},r.prototype.hideCommentLayoutPanel=function(){var t=this._sheet;n.GC$(t._commentRender._commentLayoutPanel).hide()},r.prototype.hoverShowComment=function(n){var i=this,r=i._activeComment;if(r)if(r.displayMode()===1){if(r.commentState()===2)return}else if(r.commentState()===2||r.commentState()===1)return;n!==i._hoverShowComment&&(i._hoverShowComment&&i.hideComment(i._hoverShowComment),n&&n.displayMode()==2?i._mouseCapture.capture||n._timeout||(i._hoverShowComment=n,n._timeout=setTimeout(function(){i.showComment(n)},200)):i._hoverShowComment=t)},r.prototype._isHitTestComment=function(n,t,i){var u=this.getCommentView(n),r;return u&&(r=u.getCommentRect(),r)?r.contains(t,i):!1},r.prototype._isHitTestCommentEditArea=function(n,t,i){var u=this.getCommentView(n),r;return u&&(r=u.getCommentEditAreaRect(),r)?r.contains(t,i):!1},r.prototype.getCommentHitInfo=function(n,i){for(var u,f=this,r=t,e=0;e<f._commentList.length;e++)(u=f._commentList[e],f._sheet.canEditComment(u))&&f._isHitTestComment(u,n,i)&&(r?u.zIndex()>r.zIndex()&&(r=u):r=u);return r?f._isHitTestCommentEditArea(r,n,i)?{x:n,y:i,comment:r,area:"editArea"}:{x:n,y:i,comment:r,area:"moveResizeArea"}:t},r.prototype.getCommentActualZIndex=function(n){var t=this,r=t._sheet,i=t._getTopCommentZIndex();if(n===t._hoverShowComment)return i+2;else if(n===t._activeComment)return i+1;return n.zIndex()},r.prototype._updateCommentsLayoutWhenRowColumnChanged=function(){for(var i,t=this._commentViewList,n=0;n<t.length;n++)i=t[n],i.updateLayoutWhenRowColumnChanged()},r.prototype.updateCommentsLayoutWhenSheetScroll=function(){for(var i,t=this._commentViewList,n=0;n<t.length;n++)i=t[n],i.updateLayoutWhenSheetScroll()},r.prototype.fromJSON=function(n,t){var r,u,i;if(n&&n.length!==0)for(r=0;r<n.length;r++)u=n[r],i=new c,i.fromJSON(u,t),i.commentState()!==3&&(this._activeComment=i),this._sheet.setComment(i._rowIndex,i._colIndex,i)},r.prototype.toJSON=function(){var n=this._commentList,t,r;if(!n||n.length===0)return i;for(t=[],r=0;r<n.length;r++)t.push(n[r].toJSON());return t.length===0?i:t},r}();n.CommentManager=v;y=function(){function i(n){this._sheet=t;this.showWhenTouchMoveOrScroll=!0;var i=this;i._commentLayoutPanel=i._createCommentLayoutPanel();n.appendChild(i._commentLayoutPanel)}return i.prototype._createCommentLayoutPanel=function(){var i=this,t=document.createElement("div");return n.GC$(t).addClass("comment-layoutPanel no-user-select").css("position","absolute").css("left",0).css("top",0).css("height",0).css("width",0).css("overflow","visible").css("z-index",701).attr("unselectable","on"),t},i.prototype.renderCommentFloatPanel=function(t){var i=this,e=i._sheet||t,r,f,u;e._commentManager.hasComment()&&(r=t._getSheetLayout(),n.GC$(i._commentLayoutPanel).css("left",r.x+r.rowHeaderWidth).css("top",r.y+r.colHeaderHeight),i._sheet!==t&&(i._sheet&&(f=i._sheet._commentManager),f&&(u=f.getActiveComment(),u&&u.commentState()===2&&u._changeProperty("commentState",1)),i._sheet=t))},i.prototype.renderCommentCellAdorner=function(n,t,i){var c=i.row,l=i.col,u=i.x,f=i.y,r=i.width,o=i.height,s=this,h,e;t===3&&s._sheet&&(h=s._sheet.getComment(c,l),h&&(e=6,n&&r>0&&o>0&&(n.save(),n.rect(u,f,r,o),n.clip(),n.fillStyle="red",n.beginPath(),n.moveTo(u+r-e,f),n.lineTo(u+r,f),n.lineTo(u+r,f+e),n.lineTo(u+r-e,f),n.fill(),n.restore())))},i.prototype.renderComment=function(n){var f,e,u,i,r,o,s;if(this.showWhenTouchMoveOrScroll)n.showCommentLayoutPanel();else{n.hideCommentLayoutPanel();return}for(f=this._sheet,e=n.getCommentList(),u=0;u<e.length;u++)i=e[u],r=n.getCommentView(i),this._canShowComment(n,i)?(i.displayMode()===1&&i===n.getHoverShownComment()&&(n._hoverShowComment=t),r&&r.isOpen()?r.updateLayout():n.showComment(i)):r&&r.isOpen()&&n.hideComment(i);o=n.getActiveComment();o&&(s=n.getCommentView(o),s&&s.isOpen()&&f.getSelections().length>0&&f._selectionModel.clear())},i.prototype._canShowComment=function(n,t){var i=this._sheet;if(i.getColumnWidth(t._colIndex)&&i.getRowHeight(t._rowIndex))switch(t.displayMode()){case 1:return!0;case 2:if(t.commentState()===3){if(t===n.getHoverShownComment())return!0}else return n&&t!==n.getHoverShownComment()&&(n._hoverShowComment=t),!0}return!1},i}();n.CommentRender=y})(n.Sheets||(n.Sheets={}));var t=n.Sheets})(GcSpread||(GcSpread={}))
